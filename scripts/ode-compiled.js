var extras=extras||{};extras.createObject=function(a){var b=function(){};b.prototype=a;return new b};extras.inherits=function(a,b){var c=extras.createObject(b.prototype);a.parentClass_=b;c.constructor=a;a.prototype=c};extras.base=function(a){var b=arguments.callee.caller;if(b.parentClass_)return b.parentClass_.apply(a,Array.prototype.slice.call(arguments,1));return null};
extras.range=function(a,b,c){var d=[],c=c||1,e=!1;typeof a==="number"&&typeof b==="number"||(typeof a==="string"&&typeof b==="string"?(e=!0,a=a.charCodeAt(0),b=b.charCodeAt(0)):(a=isNaN(a)?0:parseInt(a,10),b=isNaN(b)?0:parseInt(b,10)));if(a>b)for(;a>=b;)d.push(e?String.fromCharCode(a):a),a-=c;else for(;a<=b;)d.push(e?String.fromCharCode(a):a),a+=c;return d};extras.isBetween=function(a,b,c){return a<=b&&b<=c};extras.isInteger=function(a){return Math.floor(a)===a?!0:!1};
extras.isArray=function(a){return a instanceof Array};extras.hasInstances=function(a){if(arguments.length===1)throw new TypeError;var b;for(b=1;b<arguments.length;b++)if(!(arguments[b]instanceof a))return!1;return!0};extras.mapMethod=function(a,b){var c=a.length;if(typeof b!=="string")throw new TypeError;var d=Array(c),e;for(e=0;e<c;e++)e in a&&(d[e]=a[e][b]());return d};extras.contains=function(a,b){var c=a.length,d;for(d=0;d<c;d++)if(a[d]===b)return!0;return!1};
extras.containsAny=function(a,b){if(extras.isArray(b)){var c;for(c=0;c<b.length;c++)if(extras.contains(a,b[c]))return!0}else throw new TypeError;return!1};extras.keys=function(a){if(a!==Object(a))throw new TypeError("extras.keys called on non-object");var b=[],c;for(c in a)Object.prototype.hasOwnProperty.call(a,c)&&b.push(c);return b};
extras.each=function(a,b){if(a===void 0||a===null)throw new TypeError;var c=Object(a),d=c.length>>>0;if(typeof b!=="function")throw new TypeError;for(var e=0;e<d;e++)e in c&&b.call(null,c[e],e,c)};extras.bind=function(a,b){if(arguments.length>2){var c=Array.prototype.slice.call(arguments,2);return function(){var d=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(d,c);return a.apply(b,d)}}else return function(){return a.apply(b,arguments)}};
extras.withoutElement=function(a,b){var c=a.indexOf(b);return a.slice(0,c).concat(a.slice(c+1))};var ode=ode||{};ode.LexingException=function(a){this.toString=function(){return"Unexpected character <"+a+"> with code "+a.charCodeAt(0)}};ode.ParsingException=function(a){this.toString=function(){return a}};ode.RuntimeException=function(a){this.toString=function(){return a}};ode.RuntimeConversionException=function(a,b,c){extras.base(this,"Cannot convert "+c.toString()+" from "+a+" to "+b)};extras.inherits(ode.RuntimeConversionException,ode.RuntimeException);
ode.RuntimeStackException=function(a){extras.base(this,a)};extras.inherits(ode.RuntimeStackException,ode.RuntimeException);ode.RuntimeCustomException=function(){extras.base(this,"Custom exception thrown by program")};extras.inherits(ode.RuntimeCustomException,ode.RuntimeException);ode.TailCallbackException=function(){this.toString=function(){return"Tail callback exception"}};ode.TokenType={OPEN_BLOCK:"open block",CLOSE_BLOCK:"close block",OPEN_SET:"open set",CLOSE_SET:"close set",STRING:"string",SEMICOLON:"semicolon",EQUALS:"equals",NAME:"name",NUMBER:"number",CHARACTER:"character"};ode.Token=function(a,b,c){this.getType=function(){return a};this.getRepr=function(){return b};this.getVal=function(){return c};this.toString=function(){return"Token<"+a+","+b+","+c+">"}};
ode.Lexer=function(a){function b(a){return extras.contains(extras.range("A","Z"),a)||extras.contains(extras.range("a","z"),a)||extras.contains(o,a)}function c(a){return b(a)||d(a)||extras.contains(["="],a)}function d(a){return extras.contains(extras.range("0","9"),a)}function e(a){return d(a)||extras.contains(["."],a)}function g(a){return!extras.contains([" ","\t","\n"],a)}function h(a){return a==='"'}function l(){if(f<a.length){var c=a.charAt(f);if(c==="-")return c=a.charAt(f+1),d(c)?m():n();else if(c===
"'"){c="";for(f++;f<a.length&&g(a.charAt(f));)c+=a.charAt(f),f+=1;return new ode.Token(ode.TokenType.CHARACTER,"'"+c,c)}else if(c==='"'){c="";for(f++;f<a.length&&!h(a.charAt(f));)c+=a.charAt(f),f+=1;f++;return new ode.Token(ode.TokenType.STRING,'"'+c+'"',c)}else if(b(c))return n();else if(d(c))return m();else if(extras.contains([" ","\t","\n"],c))return f+=1,l();else switch(c){case "[":return i(new ode.Token(ode.TokenType.OPEN_BLOCK,"["));case "]":return i(new ode.Token(ode.TokenType.CLOSE_BLOCK,
"]"));case "{":return i(new ode.Token(ode.TokenType.OPEN_SET,"{"));case "}":return i(new ode.Token(ode.TokenType.CLOSE_SET,"}"));case "=":return i(new ode.Token(ode.TokenType.EQUALS,"="));case ";":return i(new ode.Token(ode.TokenType.SEMICOLON,";"));default:throw new ode.LexingException(c);}}else return null}function m(){var b="";a.charAt(f)==="-"&&(b+="-",f+=1);for(;f<a.length&&e(a.charAt(f));)b+=a.charAt(f),f+=1;return new ode.Token(ode.TokenType.NUMBER,b,parseFloat(b))}function n(){for(var b="";f<
a.length&&c(a.charAt(f));)b+=a.charAt(f),f+=1;return new ode.Token(ode.TokenType.NAME,b)}function i(a){f+=1;return a}var k=[],j=0,f=0;this.getInput=function(){return a};this.getCurrent=function(){j>=k.length&&k.push(l());return k[j]};this.movePrev=function(){j-=1};this.moveNext=function(){j+=1};var o=["+","-",".","<",">","*","/","#","?","$"]};ode.Node=function(){};ode.NestableNode=function(){extras.base(this)};extras.inherits(ode.NestableNode,ode.Node);ode.AtomicNode=function(a){extras.base(this);this.val=a};extras.inherits(ode.AtomicNode,ode.NestableNode);ode.AtomicNode.prototype.toString=function(){return this.val.toString()};ode.NameNode=function(a){extras.base(this,a)};extras.inherits(ode.NameNode,ode.AtomicNode);ode.BooleanNode=function(a){extras.base(this,a)};extras.inherits(ode.BooleanNode,ode.AtomicNode);
ode.BooleanNode.prototype.toString=function(){return this.val?"true":"false"};ode.CharacterNode=function(a){extras.base(this,a)};extras.inherits(ode.CharacterNode,ode.AtomicNode);ode.CharacterNode.prototype.toString=function(){return"'"+this.val};ode.NumberNode=function(a){extras.base(this,a)};extras.inherits(ode.NumberNode,ode.AtomicNode);ode.NumberNode.prototype.toString=function(){return Math.floor(this.val)===this.val?Math.floor(this.val).toString():this.val.toString()};
ode.NumberNode.prototype.toBooleanValue=function(){if(this.val===0)return!1;else if(this.val===1)return!0;else throw new ode.RuntimeConversionException("number","boolean",this.val);};ode.NumberNode.prototype.toNumberValue=function(){return parseFloat(this.val.toString())};ode.AggregateNode=function(a){extras.base(this);this.nodes=a};extras.inherits(ode.AggregateNode,ode.NestableNode);ode.BlockNode=function(a){extras.base(this,a)};extras.inherits(ode.BlockNode,ode.AggregateNode);
ode.BlockNode.prototype.toString=function(){return this.nodes.length>0?"["+extras.mapMethod(this.nodes,"toString").join(" ")+"]":"[]"};ode.BlockNode.prototype.concatenate=function(a){return new ode.BlockNode(this.nodes.concat(a.nodes))};ode.BlockNode.prototype.prepend=function(a){return new ode.BlockNode([a].concat(this.nodes))};ode.SetNode=function(a){extras.base(this,a)};extras.inherits(ode.SetNode,ode.AggregateNode);
ode.SetNode.prototype.toString=function(){return this.nodes.length>0?"{"+extras.mapMethod(this.nodes,"toString").join(" ")+"}":"{}"};ode.StringNode=function(a){extras.base(this,null);this.val=a};extras.inherits(ode.StringNode,ode.AggregateNode);ode.StringNode.prototype.toString=function(){return this.val.length>0?'"'+this.val+'"':'""'};ode.StatementNode=function(){extras.base(this)};extras.inherits(ode.StatementNode,ode.Node);ode.PhraseStatementNode=function(a){extras.base(this);this.nodes=a};
extras.inherits(ode.PhraseStatementNode,ode.StatementNode);ode.PhraseStatementNode.prototype.toString=function(){return extras.mapMethod(this.nodes,"toString").join(" ")};ode.DefinitionStatementNode=function(a,b){extras.base(this);this.name=a;this.body=b};extras.inherits(ode.DefinitionStatementNode,ode.StatementNode);ode.DefinitionStatementNode.prototype.toString=function(){return this.name+" = "+this.body.toString()+";"};ode.ProgramNode=function(a){extras.base(this);this.statements=a};
extras.inherits(ode.ProgramNode,ode.Node);ode.ProgramNode.prototype.toString=function(){return extras.mapMethod(this.statements,"toString").join("; ")};ode.Parser=function(){function a(a){for(var c=[],g=!0;a.getCurrent()!==null&&g;){var h=a.getCurrent();h&&h.getType()===ode.TokenType.SEMICOLON?(a.moveNext(),g=!1):(c.push(b(a)),a.moveNext())}return new ode.PhraseStatementNode(c)}function b(a){var e=a.getCurrent();if(e)switch(e.getType()){case ode.TokenType.OPEN_BLOCK:case ode.TokenType.OPEN_SET:case ode.TokenType.STRING:a:{if(e=a.getCurrent())switch(e.getType()){case ode.TokenType.OPEN_BLOCK:a.moveNext();for(var e=[],g=!0;a.getCurrent()!==null&&g;){var h=
a.getCurrent();h&&h.getType()===ode.TokenType.CLOSE_BLOCK?g=!1:(e.push(b(a)),a.moveNext())}a=new ode.BlockNode(e);break a;case ode.TokenType.OPEN_SET:a.moveNext();e=[];for(g=!0;a.getCurrent()!==null&&g;)(h=a.getCurrent())&&h.getType()===ode.TokenType.CLOSE_SET?g=!1:(e.push(c(a)),a.moveNext());a=new ode.SetNode(e);break a;case ode.TokenType.STRING:a=a.getCurrent();a=new ode.StringNode(a.getVal());break a}break}return a;case ode.TokenType.NAME:case ode.TokenType.NUMBER:case ode.TokenType.CHARACTER:return c(a);
case ode.TokenType.CLOSE_BLOCK:case ode.TokenType.CLOSE_SET:throw new ode.ParsingException("Unbalanced brackets");case ode.TokenType.SEMICOLON:throw new ode.ParsingException("Unexpected end of statement");case ode.TokenType.EQUALS:throw new ode.ParsingException("Only a name can appear before '=' in a definition");}throw new ode.ParsingException("Unexpected token: "+a.getCurrent().getRepr());}function c(a){var b=a.getCurrent();if(b)switch(b.getType()){case ode.TokenType.NAME:return b=a.getCurrent(),
b.getRepr()==="true"?new ode.BooleanNode(!0):b.getRepr()==="false"?new ode.BooleanNode(!1):new ode.NameNode(a.getCurrent().getRepr());case ode.TokenType.NUMBER:return new ode.NumberNode(a.getCurrent().getVal());case ode.TokenType.CHARACTER:return new ode.CharacterNode(a.getCurrent().getVal())}throw new ode.ParsingException("Unexpected token: "+a.getCurrent().getRepr());}this.parse=function(a){for(var b=[];a.getCurrent()!==null;)b.push(this.parseStatement(a));return new ode.ProgramNode(b)};this.parseStatement=
function(b){var c=b.getCurrent();if(c&&c.getType()===ode.TokenType.NAME)if(b.moveNext(),(c=b.getCurrent())&&c.getType()===ode.TokenType.EQUALS){b.movePrev();if((c=b.getCurrent())&&c.getType()===ode.TokenType.NAME){c=b.getCurrent().getRepr();b.moveNext();var g=ode.TokenType.EQUALS,h=b.getCurrent();if(h&&h.getType()===g)b.moveNext();else throw new ode.ParsingException("Unexpected token. Expected: =; Actual: "+b.getCurrent().getRepr());b=new ode.DefinitionStatementNode(c,a(b))}else throw new ode.ParsingException("Unexpected token in definition: "+
b.getCurrent().getRepr());return b}else return b.movePrev(),a(b);else return a(b)}};ode.AbstractDefinitionBody=function(){};ode.NativeDefinitionBody=function(a){extras.base(this);this.nativeFunction=a};extras.inherits(ode.NativeDefinitionBody,ode.AbstractDefinitionBody);ode.CustomDefinitionBody=function(a){extras.base(this);this.phraseNode=a};extras.inherits(ode.CustomDefinitionBody,ode.AbstractDefinitionBody);ode.SymbolTable=function(){this.natives={};this.customs={}};
ode.SymbolTable.prototype.set=function(a,b){if(b instanceof ode.CustomDefinitionBody)this.customs[a]=b;else if(b instanceof ode.NativeDefinitionBody)this.natives[a]=b;else throw new ode.RuntimeException("Symbol Table does not recognize definition type");};ode.SymbolTable.prototype.drop=function(a){if(this.customs[a])delete this.customs[a];else if(this.natives[a])throw new ode.RuntimeException("Cannot drop native definitions");else throw new ode.RuntimeException("No definition found to drop");};
ode.SymbolTable.prototype.get=function(a){return this.customs[a]?this.customs[a]:this.natives[a]};ode.SymbolTable.prototype.emptyCustomDefinitions=function(){this.customs={}};ode.SymbolTable.prototype.toString=function(){var a="";extras.each([this.natives,this.customs],function(b){extras.each(extras.keys(b),function(c){a+=c+" = ";c=b[c];a+=c instanceof ode.CustomDefinitionBody?c.phraseNode.toString():c instanceof ode.NativeDefinitionBody?"<native definition>":"<unknown>";a+=";\n"})});return a};
ode.SymbolTable.prototype.stringifyCustomDefinitions=function(a){var b=[],c=this.customs;extras.each(extras.keys(this.customs),function(a){var e=c[a];e instanceof ode.CustomDefinitionBody&&b.push(a+" = "+e.phraseNode.toString()+";")});return b.join(a)};ode.RuntimeStack=function(){var a=[];this.top=function(){if(a.length===0)throw new ode.RuntimeStackException("Stack empty");return a[a.length-1]};this.pop=function(){if(a.length===0)throw new ode.RuntimeStackException("Stack empty");return a.pop()};this.push=function(b){if(a.length>5E3)throw new ode.RuntimeStackException("Stack has reached limit of 5000 items; Operation terminated");a.push(b)};this.drop=function(b){if(!extras.isBetween(0,b,a.length-1))throw new ode.RuntimeStackException("Attempted drop outside of stack bounds; stack size = "+
a.length+"; position = "+b.toString());if(!extras.isInteger(b))throw new ode.RuntimeStackException("Drop expects non-negative integer, got: "+b.toString());a.splice(a.length-1-b,1)};this.duplicate=function(b){if(!extras.isBetween(0,b,a.length-1))throw new ode.RuntimeStackException("Attempted duplication outside of stack bounds; stack size = "+a.length+"; position = "+b.toString());if(!extras.isInteger(b))throw new ode.RuntimeStackException("Duplication expects non-negative integer, got: "+b.toString());
a.push(a[a.length-1-b])};this.rotate=function(b){if(b>a.length)throw new ode.RuntimeStackException("Attempted to rotate more items than on stack; stack size = "+a.length+"; number to rotate = "+b);a.push(a.splice(a.length-b,1)[0])};this.empty=function(){a=[]};this.toString=function(){return extras.mapMethod(a,"toString").join(" ")};this.getInternalArray=function(){return a};this.setInternalArray=function(b){a=b}};
ode.FrameStack=function(){var a=[];this.push=function(b){a.push(b)};this.top=function(){if(a.length===0)throw new ode.RuntimeStackException("Frame stack empty; Cannot get top");return a[a.length-1]};this.pop=function(){if(a.length===0)throw new ode.RuntimeStackException("Frame stack empty; Cannot pop");return a.pop()};this.dropAllChildFrames=function(){for(;a.length>1;)this.pop()};this.getLength=function(){return a.length}};ode.Environment=function(a,b,c,d,e){this.stack=a;this.symbolTable=b;this.print=c;this.runNestableNodes=d;this.runCreateBlock=e;this.frames=new ode.FrameStack;this.frames.push(this.stack)};ode.Environment.prototype.enterFrame=function(){this.frames.push(new ode.RuntimeStack);this.stack=this.frames.top()};ode.Environment.prototype.exitFrame=function(){this.frames.pop();this.stack=this.frames.top()};ode.Environment.prototype.resetFrames=function(){this.frames.dropAllChildFrames();this.stack=this.frames.top()};
ode.Environment.prototype.getStackNodes=function(){return this.stack.getInternalArray()};ode.Environment.prototype.parameterError=function(a,b,c){throw new ode.RuntimeException("Operation <"+a+"> expected <"+b+"> but got <"+c+">");};ode.Environment.prototype.expectationError=function(a,b,c){b=extras.isArray(b)?b.join(","):b;c=extras.mapMethod(c,"toString").join(",");throw new ode.RuntimeException("Operation <"+a+"> expected <"+b+"> but got <"+c+">");};
ode.Interpreter=function(a,b,c){this.e=new ode.Environment(a,b,c,extras.bind(this.runNestableNodes,this),extras.bind(this.runCreateBlock,this))};ode.Interpreter.prototype.run=function(a){var b=this;extras.each(a.statements,function(a){try{if(a instanceof ode.DefinitionStatementNode)b.runDefinition(a);else if(a instanceof ode.PhraseStatementNode)b.runPhrase(a,0);else throw new ode.RuntimeException("Unrecognized statement: <"+a.toString()+">");}catch(d){throw b.e.resetFrames(),d;}})};
ode.Interpreter.prototype.runPhrase=function(a,b){if(b>100)throw new ode.RuntimeException("Possible infinite recursion detected; Operation terminated");this.runNestableNodes(a.nodes,b)};
ode.Interpreter.prototype.runNestableNodes=function(a,b){var c=this,d=b||0;extras.each(a,function(a){if(a instanceof ode.BlockNode)c.runBlock(a);else if(a instanceof ode.SetNode)c.runSet(a);else if(a instanceof ode.StringNode)c.runString(a.val);else if(a instanceof ode.NameNode)c.runName(a.val,d);else if(a instanceof ode.NumberNode)c.runNumber(a.val);else if(a instanceof ode.BooleanNode)c.runBoolean(a.val);else if(a instanceof ode.CharacterNode)c.runCharacter(a.val);else throw new ode.RuntimeException("Unrecognized nested node: <"+
a.toString()+">");})};ode.Interpreter.prototype.runDefinition=function(a){this.e.symbolTable.set(a.name,new ode.CustomDefinitionBody(a.body))};ode.Interpreter.prototype.runBlock=function(a){this.e.stack.push(a)};ode.Interpreter.prototype.runSet=function(a){this.e.stack.push(a)};ode.Interpreter.prototype.runString=function(a){this.e.stack.push(new ode.StringNode(a))};ode.Interpreter.prototype.runNumber=function(a){this.e.stack.push(new ode.NumberNode(a))};ode.Interpreter.prototype.runBoolean=function(a){this.e.stack.push(new ode.BooleanNode(a))};
ode.Interpreter.prototype.runCharacter=function(a){this.e.stack.push(new ode.CharacterNode(a))};
ode.Interpreter.prototype.runName=function(a,b){var c=this.e.symbolTable.get(a);if(c instanceof ode.CustomDefinitionBody)for(;;){try{this.runPhrase(c.phraseNode,b+1)}catch(d){if(d instanceof ode.TailCallbackException)continue;else throw d;}break}else if(c instanceof ode.NativeDefinitionBody)c.nativeFunction(this.e);else if(a==="self")throw new ode.TailCallbackException;else throw new ode.RuntimeException("Undefined name: "+a);};
ode.Interpreter.prototype.runCreateBlock=function(a){var b=this,c=[];a>0&&extras.each(extras.range(a-1),function(){c.unshift(b.e.stack.pop())});this.e.stack.push(new ode.BlockNode(c))};ode.Interpreter.prototype.addNativeOperation=function(a,b){this.e.symbolTable.set(a,new ode.NativeDefinitionBody(b))};ode.joynatives=ode.joynatives||{};
ode.joynatives.initialize=function(a){a.addNativeOperation(".",ode.joynatives.print);a.addNativeOperation("+",ode.joynatives.makeMathOperator("+","+"));a.addNativeOperation("-",ode.joynatives.makeMathOperator("-","-"));a.addNativeOperation("*",ode.joynatives.makeMathOperator("*","*"));a.addNativeOperation("/",ode.joynatives.makeMathOperator("/","/"));a.addNativeOperation("<",ode.joynatives.makeComparisonOperator("<","<"));a.addNativeOperation(">",ode.joynatives.makeComparisonOperator(">",">"));a.addNativeOperation("<=",
ode.joynatives.makeComparisonOperator("<=","<="));a.addNativeOperation(">=",ode.joynatives.makeComparisonOperator(">=",">="));a.addNativeOperation("eq",ode.joynatives.makeComparisonOperator("===","eq"));a.addNativeOperation("ifte",ode.joynatives.ifte);a.addNativeOperation("dup",ode.joynatives.dup);a.addNativeOperation("dup#",ode.joynatives.dupLocation);a.addNativeOperation("swap",ode.joynatives.swap);a.addNativeOperation("drop",ode.joynatives.drop);a.addNativeOperation("drop#",ode.joynatives.dropLocation);
a.addNativeOperation("rot",ode.joynatives.makeRot(3));a.addNativeOperation("number?",ode.joynatives.numberPredicate);a.addNativeOperation("block?",ode.joynatives.blockPredicate);a.addNativeOperation("empty?",ode.joynatives.emptyPredicate);a.addNativeOperation("$eval",ode.joynatives.evaluate);a.addNativeOperation("$type",ode.joynatives.type);a.addNativeOperation("$def",ode.joynatives.dollarDef);a.addNativeOperation("def",ode.joynatives.def);a.addNativeOperation("undef",ode.joynatives.undef);a.addNativeOperation("newstack",
ode.joynatives.newstack);a.addNativeOperation("throw-error",ode.joynatives.throwError);a.addNativeOperation("apply",ode.joynatives.apply);a.addNativeOperation("cat",ode.joynatives.cat);a.addNativeOperation("block",ode.joynatives.block);a.addNativeOperation("block#",ode.joynatives.blockLocation);a.addNativeOperation("cons",ode.joynatives.cons);a.addNativeOperation("uncons",ode.joynatives.uncons);a.addNativeOperation("stack",ode.joynatives.stack);a.addNativeOperation("unstack",ode.joynatives.unstack);
a.addNativeOperation("length",ode.joynatives.length);a.addNativeOperation("map",ode.joynatives.map);a.addNativeOperation("fold",ode.joynatives.fold)};ode.joynatives.makeComparisonOperator=function(a,b){return function(c){var d=c.stack.pop(),e=c.stack.pop();e.toNumberValue&&d.toNumberValue?eval(e.toNumberValue().toString()+a+d.toNumberValue().toString())?c.stack.push(new ode.NumberNode(1)):c.stack.push(new ode.NumberNode(0)):c.parameterError(b,"number, number",e.toString()+", "+d.toString())}};
ode.joynatives.makeMathOperator=function(a,b){return function(c){var d=c.stack.pop(),e=c.stack.pop();e.toNumberValue&&d.toNumberValue?(d=eval(e.toNumberValue().toString()+" "+a+" "+d.toNumberValue().toString()),c.stack.push(new ode.NumberNode(d))):c.parameterError(b,"number, number",e.toString()+", "+d.toString())}};
ode.joynatives.print=function(a){var b=a.stack.pop();b instanceof ode.NumberNode?a.print(b.toString()):b instanceof ode.BlockNode?a.print(b.toString()):b instanceof ode.NameNode?a.print(b.toString()):a.parameterError(".","number, name, or block",b.toString())};ode.joynatives.dup=function(a){a.stack.duplicate(0)};ode.joynatives.dupLocation=function(a){var b=a.stack.pop();b.toNumberValue?(b=b.toNumberValue(),a.stack.duplicate(b)):a.parameterError("dup#","number",b.toString())};
ode.joynatives.swap=function(a){var b=a.stack.pop(),c=a.stack.pop();a.stack.push(b);a.stack.push(c)};ode.joynatives.apply=function(a){var b=a.stack.pop();b instanceof ode.BlockNode?a.runNestableNodes(b.nodes):a.parameterError("apply","block",b.toString())};
ode.joynatives.ifte=function(a){var b=a.stack.pop(),c=a.stack.pop(),d=a.stack.pop();extras.hasInstances(ode.BlockNode,d,c,b)?(a.stack.push(d),ode.joynatives.apply(a),d=a.stack.pop(),d.toBooleanValue?(d.toBooleanValue()?a.stack.push(c):a.stack.push(b),ode.joynatives.apply(a)):a.parameterError("ifte","boolean",d.toString())):a.parameterError("ifte","three blocks",d.toString()+","+c.toString()+","+b.toString())};
ode.joynatives.dropLocation=function(a){var b=a.stack.pop();if(b.toNumberValue){var c=b.toNumberValue();extras.isInteger(c)&&c>=0?a.stack.drop(c):a.parameterError("drop#","non-negative integer",b.toString())}else a.parameterError("drop#","number",b.toString())};ode.joynatives.drop=function(a){a.stack.pop()};ode.joynatives.numberPredicate=function(a){a.stack.pop()instanceof ode.NumberNode?a.stack.push(new ode.NumberNode(1)):a.stack.push(new ode.NumberNode(0))};
ode.joynatives.blockPredicate=function(a){a.stack.pop()instanceof ode.BlockNode?a.stack.push(new ode.NumberNode(1)):a.stack.push(new ode.NumberNode(0))};ode.joynatives.emptyPredicate=function(a){var b=a.stack.pop();b instanceof ode.BlockNode?b.nodes.length===0?a.stack.push(new ode.NumberNode(1)):a.stack.push(new ode.NumberNode(0)):a.parameterError("empty?","block",b.toString())};
ode.joynatives.cat=function(a){var b=a.stack.pop(),c=a.stack.pop();c instanceof ode.BlockNode&&b instanceof ode.BlockNode?a.stack.push(c.concatenate(b)):a.parameterError("cat","two blocks",c.toString()+","+b.toString())};ode.joynatives.cons=function(a){var b=a.stack.pop(),c=a.stack.pop();b instanceof ode.BlockNode?a.stack.push(b.prepend(c)):a.parameterError("cons","node,block",c.toString()+","+b.toString())};
ode.joynatives.uncons=function(a){var b=a.stack.pop();b instanceof ode.BlockNode?(b.nodes.length===0&&a.parameterError("uncons","non-empty block",b.toString()),a.stack.push(b.nodes[0]),a.stack.push(new ode.BlockNode(b.nodes.slice(1)))):a.parameterError("uncons","block",b.toString())};ode.joynatives.block=function(a){a.runCreateBlock(1)};
ode.joynatives.blockLocation=function(a){var b=a.stack.pop();if(b.toNumberValue){var c=b.toNumberValue();extras.isInteger(c)&&c>=0?a.runCreateBlock(c):a.parameterError("block#","non-negative integer",b.toString())}else a.parameterError("block#","number",b.toString())};ode.joynatives.makeRot=function(a){return function(b){b.stack.rotate(a)}};
ode.joynatives.evaluate=function(a){var b=a.stack.pop();b instanceof ode.BlockNode?(a.enterFrame(),a.stack.push(b),ode.joynatives.apply(a),b=a.getStackNodes(),a.exitFrame(),a.stack.push(new ode.BlockNode(b))):a.parameterError("$eval","block",b.toString())};
ode.joynatives.type=function(a){var b=a.stack.pop();b instanceof ode.NameNode?a.stack.push(new ode.BlockNode([new ode.NameNode("name")])):b instanceof ode.NumberNode?a.stack.push(new ode.BlockNode([new ode.NameNode("number")])):b instanceof ode.BlockNode?a.stack.push(new ode.BlockNode([new ode.NameNode("block")])):a.stack.push(new ode.BlockNode([new ode.NameNode("?")]))};
ode.joynatives.dollarDef=function(a){var b=a.stack.pop();extras.hasInstances(ode.BlockNode,b)||a.parameterError("$def","block",b.toString());b.nodes.length===0&&a.parameterError("$def","name in a block",b.toString());b=b.nodes[0];extras.hasInstances(ode.NameNode,b)||a.parameterError("$def","name in a block",b.toString());b=a.symbolTable.get(b.toString());b=b instanceof ode.CustomDefinitionBody?new ode.BlockNode(b.phraseNode.nodes):b instanceof ode.NativeDefinitionBody?new ode.BlockNode([new ode.NameNode("native")]):
new ode.BlockNode([new ode.NameNode("unknown")]);a.stack.push(b)};ode.joynatives.map=function(a){var b=a.stack.pop(),c=a.stack.pop();if(extras.hasInstances(ode.BlockNode,b,c)){var d=[];a.enterFrame();extras.each(c.nodes,function(c){a.stack.push(c);a.stack.push(b);ode.joynatives.apply(a);extras.each(a.getStackNodes(),function(a){d.push(a)});a.stack.empty()});a.exitFrame();a.stack.push(new ode.BlockNode(d))}else a.parameterError("map","two blocks",b.toString()+","+c.toString())};
ode.joynatives.fold=function(a){var b=a.stack.pop(),c=a.stack.pop(),d=a.stack.pop();extras.hasInstances(ode.BlockNode,b,d)?(a.enterFrame(),a.stack.push(c),extras.each(d.nodes,function(c){a.stack.push(c);a.stack.push(b);ode.joynatives.apply(a)}),c=a.getStackNodes(),a.exitFrame(),extras.each(c,function(b){a.stack.push(b)})):a.expectationError("map","list,value,block",[d,c,b])};
ode.joynatives.def=function(a){var b=a.stack.pop(),c=a.stack.pop();extras.hasInstances(ode.BlockNode,b,c)||a.expectationError("def",["block","block"],[b,c]);b.nodes.length!==1&&a.expectationError("def",["name in a block"],[b]);b=b.nodes[0];extras.hasInstances(ode.NameNode,b)||a.expectationError("def",["name in a block"],[b]);c=new ode.PhraseStatementNode(c.nodes);c=new ode.CustomDefinitionBody(c);a.symbolTable.set(b.val,c)};
ode.joynatives.undef=function(a){var b=a.stack.pop();extras.hasInstances(ode.BlockNode,b)||a.expectationError("undef",["block"],[b]);b.nodes.length!==1&&a.expectationError("undef",["name in a block"],[b]);b=b.nodes[0];extras.hasInstances(ode.NameNode,b)||a.expectationError("undef",["name in a block"],[b]);a.symbolTable.drop(b.val)};ode.joynatives.stack=function(a){var b=a.stack.getInternalArray().slice(),b=new ode.BlockNode(b);a.stack.push(b)};
ode.joynatives.unstack=function(a){var b=a.stack.pop();extras.hasInstances(ode.BlockNode,b)||a.expectationError("unstack","block",[b]);a.stack.setInternalArray(b.nodes)};ode.joynatives.newstack=function(a){a.stack.empty()};ode.joynatives.throwError=function(){throw new ode.RuntimeCustomException;};ode.joynatives.length=function(a){var b=a.stack.pop();extras.hasInstances(ode.BlockNode,b)||a.expectationError("length","block",[b]);a.stack.push(new ode.NumberNode(b.nodes.length))};ode.Controller=function(a,b,c,d,e,g){this.outputFun=a;this.errorFun=b||a;this.stack=c||new ode.RuntimeStack;this.symbolTable=d||new ode.SymbolTable;this.parser=e||new ode.Parser;this.interpreter=g||new ode.Interpreter(this.stack,this.symbolTable,this.outputFun);ode.joynatives.initialize(this.interpreter)};
ode.Controller.prototype.exec=function(a){try{this.execNoErrorHandling(a)}catch(b){b instanceof ode.LexingException?this.errorFun("Lexing error: "+b.toString()):b instanceof ode.ParsingException?this.errorFun("Parsing error: "+b.toString()):b instanceof ode.RuntimeException?this.errorFun("Runtime error: "+b.toString()):b instanceof ode.TailCallbackException?this.errorFun("Runtime error: 'self' used outside of definition"):(a="Error",b instanceof Error?(a="JavaScript Error",typeof b.name!=="undefined"&&
b.name.length>0&&(a+="\n  Name: "+b.name),typeof b.message!=="undefined"&&b.message.length>0&&(a+="\n  Message: "+b.message),typeof b.description!=="undefined"&&b.description.length>0&&(a+="\n  Description: "+b.description),typeof b.number!=="undefined"&&b.number.length>0&&(a+="\n  Error Number: "+b.number)):a="Unrecognized Error:"+b.toString(),this.errorFun(a))}};ode.Controller.prototype.execNoErrorHandling=function(a){this.interpreter.run(this.parser.parse(new ode.Lexer(a)))};
ode.Controller.prototype.emptyStack=function(){this.stack.empty()};ode.Controller.prototype.emptyCustomDefinitions=function(){this.symbolTable.emptyCustomDefinitions()};ode.Controller.prototype.stringifyStack=function(){return this.stack.toString()};ode.Controller.prototype.stringifyCustomDefinitions=function(a){return this.symbolTable.stringifyCustomDefinitions(a||" ")};ode.Controller.prototype.getAuthorInfo=function(){return"Kevin P. Albrecht"};ode.Controller.prototype.getVersionInfo=function(){return"Ode v0.4.0dev"};
